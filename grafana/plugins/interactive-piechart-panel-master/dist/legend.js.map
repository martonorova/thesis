{"version":3,"sources":["../src/legend.js"],"names":["angular","kbn","$","module","directive","popoverSrv","$timeout","link","scope","elem","$container","firstRender","ctrl","panel","data","seriesList","combined","i","events","on","series","label","color","serie","_","find","render","getSeriesIndexForElement","el","parents","toggleSeries","e","currentTarget","index","scrollPosition","children","scrollTop","seriesInfo","toggleCombinedSeries","clickAction","updateVariable","sortLegend","stat","legend","sort","sortDesc","getLegendHeaderHtml","statName","name","header","html","cssClass","getLegendPercentageHtml","openColorSelector","target","length","show","element","position","template","openOn","model","autoClose","toggleAxis","colorSelected","changeSeriesColor","legendType","empty","append","showValues","values","percentage","tableLayout","toggleClass","legendHeader","valueName","sortBy","seriesData","reverse","total","seriesElements","value","combine","threshold","push","hideEmpty","allIsNull","decimal","percentageDecimals","selectedSeries","alias","formatValue","pvalue","toFixed","labelsInOthers","map","combinedSliceColor","includes","sumBy","s","maxHeight","height","topPadding","tbodyElem","css"],"mappings":"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","file":"legend.js","sourcesContent":["import angular from 'angular';\n//import _ from  'lodash';\nimport kbn from 'app/core/utils/kbn';\nimport $ from  'jquery';\nimport 'jquery.flot';\nimport 'jquery.flot.time';\n\nangular.module('grafana.directives').directive('piechartLegend', function(popoverSrv, $timeout) {\n  return {\n    link: function(scope, elem) {\n      var $container = $('<section class=\"graph-legend\"></section>');\n      var firstRender = true;\n      var ctrl = scope.ctrl;\n      var panel = ctrl.panel;\n      var data;\n      var seriesList;\n      var combined;\n      var i;\n\n      ctrl.events.on('render', function() {\n        data = ctrl.series;\n        if (data) {\n          for(var i in data) {\n            const label = ctrl.data[i].label;\n            const color = ctrl.data[i].color;\n\n            const serie = _.find(ctrl.series, {'label':label})\n            if (serie) {\n              serie.color = color;\n            }\n          }\n          render();\n        }\n      });\n\n      function getSeriesIndexForElement(el) {\n        return el.parents('[data-series-index]').data('series-index');\n      }\n\n      function toggleSeries(e) {\n        var el = $(e.currentTarget);\n        var index = getSeriesIndexForElement(el);\n        var scrollPosition = $($container.children('tbody')).scrollTop();\n\n        if (index != -1) {\n          var seriesInfo = seriesList[index];\n          ctrl.toggleSeries(seriesInfo);\n        } else {\n          // when the combined slice is toggled\n          ctrl.toggleCombinedSeries(combined);\n        }\n\n        if (ctrl.panel.clickAction === 'Update variable') {\n          ctrl.updateVariable();\n        } else {\n          ctrl.render();\n          $($container.children('tbody')).scrollTop(scrollPosition);\n        }\n      }\n\n      function sortLegend(e) {\n        var el = $(e.currentTarget);\n        var stat = el.data('stat');\n\n        if (stat !== panel.legend.sort) { panel.legend.sortDesc = null; }\n\n        // if already sort ascending, disable sorting\n        if (panel.legend.sortDesc === false) {\n          panel.legend.sort = null;\n          panel.legend.sortDesc = null;\n          ctrl.render();\n          return;\n        }\n\n        panel.legend.sortDesc = !panel.legend.sortDesc;\n        panel.legend.sort = stat;\n        ctrl.render();\n      }\n\n      function getLegendHeaderHtml(statName) {\n        var name = statName;\n\n        if (panel.legend.header) {\n          name = panel.legend.header;\n        }\n\n        var html = '<th class=\"pointer\" data-stat=\"' + statName + '\">' + name;\n\n        if (panel.legend.sort === statName) {\n          var cssClass = panel.legend.sortDesc ? 'fa fa-caret-down' : 'fa fa-caret-up' ;\n          html += ' <span class=\"' + cssClass + '\"></span>';\n        }\n\n        return html + '</th>';\n      }\n\n      function getLegendPercentageHtml(statName) {\n        var name = 'percentage';\n        var html = '<th class=\"pointer\" data-stat=\"' + statName + '\">' + name;\n\n        if (panel.legend.sort === statName) {\n          var cssClass = panel.legend.sortDesc ? 'fa fa-caret-down' : 'fa fa-caret-up' ;\n          html += ' <span class=\"' + cssClass + '\"></span>';\n        }\n\n        return html + '</th>';\n      }\n\n      function openColorSelector(e) {\n        // if we clicked inside poup container ignore click\n        if ($(e.target).parents('.popover').length) {\n          return;\n        }\n\n        var el = $(e.currentTarget).find('.fa-minus');\n        var index = getSeriesIndexForElement(el);\n        var series = seriesList[index];\n\n        $timeout(function() {\n          popoverSrv.show({\n            element: el[0],\n            position: 'bottom center',\n            template: '<series-color-picker series=\"series\" onToggleAxis=\"toggleAxis\" onColorChange=\"colorSelected\">' +\n            '</series-color-picker>',\n            openOn: 'hover',\n            model: {\n              autoClose: true,\n              series: series,\n              toggleAxis: function() {},\n              colorSelected: function(color) {\n                ctrl.changeSeriesColor(series, color);\n              }\n            },\n          });\n        });\n      }\n\n      function render() {\n        if(panel.legendType === 'On graph') {\n          $container.empty();\n          return;\n        }\n\n        if (firstRender) {\n          elem.append($container);\n          $container.on('click', '.graph-legend-icon', openColorSelector);\n          $container.on('click', '.graph-legend-alias', toggleSeries);\n          $container.on('click', 'th', sortLegend);\n          firstRender = false;\n        }\n\n        seriesList = data;\n        combined = [];\n\n        $container.empty();\n\n        var showValues = panel.legend.values || panel.legend.percentage;\n        var tableLayout = (\n            panel.legendType === 'Under graph' ||\n            panel.legendType === 'Right side'\n            ) && showValues;\n\n        $container.toggleClass('graph-legend-table', tableLayout);\n\n        var legendHeader;\n        if (tableLayout) {\n          var header = '<tr><th colspan=\"2\" style=\"text-align:left\"></th>';\n          if (panel.legend.values) {\n              header += getLegendHeaderHtml(ctrl.panel.valueName);\n          }\n          if (panel.legend.percentage) {\n            header += getLegendPercentageHtml(ctrl.panel.valueName);\n          }\n          header += '</tr>';\n          legendHeader = $(header);\n        }\n\n        if (panel.legend.sort) {\n          seriesList = _.sortBy(seriesList, function(series) {\n            return ctrl.seriesData(series);\n          });\n          if (panel.legend.sortDesc) {\n            seriesList = seriesList.reverse();\n          }\n        }\n\n        if (panel.legend.percentage) {\n          var total = 0;\n          for (i = 0; i < seriesList.length; i++) {\n            total += ctrl.seriesData(seriesList[i]);\n          }\n        }\n\n        var seriesElements = [];\n\n        for (i = 0; i < seriesList.length; i++) {\n          var series = seriesList[i];\n          var value = ctrl.seriesData(series);\n\n          // ignore if included in 'others'\n          if (ctrl.panel.combine.threshold > value/total) {\n            combined.push(series);\n            continue;\n          }\n\n          // ignore empty series\n          if (panel.legend.hideEmpty && series.allIsNull) {\n            continue;\n          }\n          // ignore series excluded via override\n          if (!series.legend) {\n            continue;\n          }\n\n          var decimal = 2;\n          if (ctrl.panel.legend.percentageDecimals) {\n            decimal = ctrl.panel.legend.percentageDecimals;\n          }\n\n          var html = '<div class=\"graph-legend-series';\n\n          if (ctrl.panel.clickAction === 'Update variable') {\n            if (!ctrl.selectedSeries[series.alias]) { html += ' graph-legend-series-hidden'; }\n          } else {\n            if (ctrl.selectedSeries[series.alias]) { html += ' graph-legend-series-hidden'; }\n          }\n          html += '\" data-series-index=\"' + i + '\">';\n          html += '<span class=\"graph-legend-icon\" style=\"float:none;\">';\n          html += '<i class=\"fa fa-minus pointer\" style=\"color:' + series.color + '\"></i>';\n          html += '</span>';\n\n          html += '<a class=\"graph-legend-alias\" style=\"float:none;\">' + series.label + '</a>';\n\n          if (showValues && tableLayout) {\n            var value = ctrl.seriesData(series);\n            if (panel.legend.values) {\n              html += '<div class=\"graph-legend-value\">' + ctrl.formatValue(value) + '</div>';\n            }\n            if (total) {\n              var pvalue = ((value / total) * 100).toFixed(decimal) + '%';\n              html += '<div class=\"graph-legend-value\">' + pvalue +'</div>';\n            }\n          }\n\n          html += '</div>';\n\n          seriesElements.push($(html));\n        }\n\n        if (combined.length > 0) {\n          // The color of the combined slice is that of a slice that meets either of below conditions first:\n          // - the first slice to be combined, or\n          // - the first slice whose label is in ctrl.selectedSeries\n          var labelsInOthers = _.map(combined, \"label\");\n          var combinedSliceColor = _.find(data, function(series) {\n            return _.includes(labelsInOthers, series.label) || (series.label in ctrl.selectedSeries);\n          }).color;\n\n          var color = combinedSliceColor;\n          var value = _.sumBy(combined, s=>ctrl.seriesData(s));\n          var label = ctrl.panel.combine.label;\n\n          var html = '<div class=\"graph-legend-series';\n          if (ctrl.selectedSeries[label]) { html += ' graph-legend-series-hidden'; }\n          html += '\" data-series-index=\"-1\">'; // -1 : the combined pie\n          html += '<span class=\"graph-legend-icon\" style=\"float:none;\">';\n          html += '<i class=\"fa fa-minus pointer\" style=\"color:' + color + '\"></i>';\n          html += '</span>';\n\n          html += '<a class=\"graph-legend-alias\" style=\"float:none;\">' + label + '</a>';\n\n          if (showValues && tableLayout) {\n            if (panel.legend.values) {\n              html += '<div class=\"graph-legend-value\">' + ctrl.formatValue(value) + '</div>';\n            }\n            if (total) {\n              var pvalue = ((value / total) * 100).toFixed(decimal) + '%';\n              html += '<div class=\"graph-legend-value\">' + pvalue +'</div>';\n            }\n          }\n\n          html += '</div>';\n\n          seriesElements.push($(html));\n        }\n\n        if (tableLayout) {\n          var maxHeight = ctrl.height;\n\n          if (panel.legendType === 'Under graph') {\n            maxHeight = maxHeight/2;\n          }\n\n          var topPadding = 6;\n          var tbodyElem = $('<tbody></tbody>');\n          tbodyElem.css(\"max-height\", maxHeight - topPadding);\n          tbodyElem.append(legendHeader);\n          tbodyElem.append(seriesElements);\n          $container.append(tbodyElem);\n        } else {\n          $container.append(seriesElements);\n        }\n      }\n    }\n  };\n});\n\n\n"]}